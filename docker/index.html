<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="manifest" href="/manifest.json" /> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="apple-touch-icon" sizes="76x76" href="/assets/images/touch-icon/logo-76.png" /> <link rel="apple-touch-icon" sizes="120x120" href="/assets/images/touch-icon/logo-120.png" /> <link rel="apple-touch-icon" sizes="152x152" href="/assets/images/touch-icon/logo-152.png" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/touch-icon/logo-180.png" /> <meta name="msapplication-square70x70logo" content="/assets/images/touch-icon/logo-70.png" /> <meta name="msapplication-square150x150logo" content="/assets/images/touch-icon/logo-150.png" /> <meta name="msapplication-square310x310logo" content="/assets/images/touch-icon/logo-310.png" /> <!-- keywords not used by google but other search engines might still use --> <meta name="keywords" content="Napkin, BigQuery, Postgres, SQL, BigData, Data Scientist, Data Engineer, Analytics" /> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Docker | docs</title> <meta name="generator" content="Jekyll v4.2.1" /> <meta property="og:title" content="Docker" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Napkin docker manual" /> <meta property="og:description" content="Napkin docker manual" /> <link rel="canonical" href="https://soostone.github.io/docker/" /> <meta property="og:url" content="https://soostone.github.io/docker/" /> <meta property="og:site_name" content="docs" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Docker" /> <script type="application/ld+json"> {"headline":"Docker","dateModified":"2021-12-02T19:15:00+00:00","url":"https://soostone.github.io/docker/","@type":"WebPage","description":"Napkin docker manual","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://soostone.github.io/assets/images/logo-and-name.svg"}},"@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="site-super-header"> <div class="site-logo"></div> <a class="link-button active" href="#">Documentation</a> <a class="link-button" href="#">Community</a> <a class="link-button" href="#">Features</a> <a class="link-button" href="#">Use Cases</a> <span class="gradient-border"> <a class="link-button " href="#">Install</a> </span> </div> <div class="side-bar" style="display: none;"> <div class="site-header"> <a href="https://soostone.github.io/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"> <li class="nav-list-item" style="display: none;"> <a class="nav-list-link" href="https://napkinweb.webflow.io/"> Napkin product </a> </li><li class="nav-list-item"><a href="https://soostone.github.io/" class="nav-list-link"> About </a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/getting-started/" class="nav-list-link"> Getting Started </a> <ul><li> <a href="/getting-started/#installation" class="nav-list-link"> Installation </a> </li><li> <a href="/getting-started/#key-features" class="nav-list-link"> Hello world </a> </li></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/tutorial/" class="nav-list-link"> Tutorial </a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/tips-and-tricks/" class="nav-list-link"> Tips and Tricks </a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/docker/" class="nav-list-link"> Docker </a> <ul><li> <a href="/docker/#basic-usage" class="nav-list-link"> Basic usage </a> </li><li> <a href="/docker/#advanced-usage" class="nav-list-link"> Advanced usage </a> </li><li> <a href="/docker/#technical-details" class="nav-list-link"> Technical details </a> </li></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/user-manual/" class="nav-list-link"> User Manual </a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/haddock/" class="nav-list-link"> Haddock </a> <ul></ul></li></ul> </nav> </div> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search docs" aria-label="Search docs" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main" id="top"> <div class="side-bar"> <ul class="nav-list"> <li class="nav-list-item" style="display: none;"> <a class="nav-list-link" href="https://napkinweb.webflow.io/"> Napkin product </a> </li><li class="nav-list-item"><a href="https://soostone.github.io/" class="nav-list-link"> About </a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/getting-started/" class="nav-list-link"> Getting Started </a> <ul><li> <a href="/getting-started/#installation" class="nav-list-link"> Installation </a> </li><li> <a href="/getting-started/#key-features" class="nav-list-link"> Hello world </a> </li></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/tutorial/" class="nav-list-link"> Tutorial </a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/tips-and-tricks/" class="nav-list-link"> Tips and Tricks </a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/docker/" class="nav-list-link"> Docker </a> <ul><li> <a href="/docker/#basic-usage" class="nav-list-link"> Basic usage </a> </li><li> <a href="/docker/#advanced-usage" class="nav-list-link"> Advanced usage </a> </li><li> <a href="/docker/#technical-details" class="nav-list-link"> Technical details </a> </li></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/user-manual/" class="nav-list-link"> User Manual </a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/haddock/" class="nav-list-link"> Haddock </a> <ul></ul></li></ul> </div> <div class="main-content-lspander"></div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 id="basic-usage"> <a href="#basic-usage" class="anchor-heading" aria-labelledby="basic-usage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Basic usage </h1> <p>The idea behind the docker wrapper script is simple: usage patterns should be indistinguishable from regular Napkin usage. It is possible to invoke any Napkin command, for example:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh &lt;<span class="o">(</span>docker run <span class="nt">--rm</span> soostone/napkin-exe <span class="nb">cat</span> /bin/napkin-docker<span class="o">)</span> init <span class="nt">-p</span> USER:example <span class="nt">-c</span>
sh &lt;<span class="o">(</span>docker run <span class="nt">--rm</span> soostone/napkin-exe <span class="nb">cat</span> /bin/napkin-docker<span class="o">)</span> validate <span class="nt">--spec-file</span> specs/spec.yaml <span class="nt">--live</span>
sh &lt;<span class="o">(</span>docker run <span class="nt">--rm</span> soostone/napkin-exe <span class="nb">cat</span> /bin/napkin-docker<span class="o">)</span> haddock
sh &lt;<span class="o">(</span>docker run <span class="nt">--rm</span> soostone/napkin-exe <span class="nb">cat</span> /bin/napkin-docker<span class="o">)</span> version
</code></pre></div></div> <h1 id="advanced-usage"> <a href="#advanced-usage" class="anchor-heading" aria-labelledby="advanced-usage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Advanced usage </h1> <p>If your Napkin project requires some extra haskell packages, which is usually specified in <code class="language-plaintext highlighter-rouge">spec.yaml</code> file:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">haskell_packages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">cassava</span>
  <span class="pi">-</span> <span class="s">cassava-embed</span>
</code></pre></div></div> <p>It is still possible to use docker wrapper script like so:</p> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">NAPKIN_EXTRA_PACKAGES</span><span class="o">=</span><span class="s2">"cassava cassava-embed"</span> sh &lt;<span class="o">(</span>docker run <span class="nt">--rm</span> soostone/napkin-exe <span class="nb">cat</span> /bin/napkin-docker<span class="o">)</span> validate
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Building custom napkin image with extra cassava cassava-embed packages, it can take a minute...
sha256:707aab0cdce3d14929134cad2d8102bb463ef4377cdad3e1c59afa62d5342689
OK
</code></pre></div></div> <p>Under the hood, wrapper script will build an extra layer to the base image with extra packages installed, so Napkin can see and use them with the following Nix expression:</p> <div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">import</span> <span class="p">(</span>
  <span class="kr">builtins</span><span class="o">.</span><span class="kr">fetchTarball</span> <span class="p">{</span>
    <span class="nv">url</span> <span class="o">=</span> <span class="s2">"https://github.com/NixOS/nixpkgs/archive/$NAPKIN_NIX_REVISION.tar.gz"</span><span class="p">;</span>
    <span class="nv">sha256</span> <span class="o">=</span> <span class="s2">"$NAPKIN_NIX_SHA256"</span><span class="p">;</span>
  <span class="p">})</span> <span class="p">{}</span>
<span class="err">)</span><span class="o">.</span><span class="nv">haskell</span><span class="o">.</span><span class="nv">packages</span><span class="o">.</span><span class="p">$</span><span class="nv">NAPKIN_GHC_VERSION_COMPACT</span><span class="o">.</span><span class="nv">ghcWithPackages</span> <span class="p">(</span><span class="nv">p</span><span class="p">:</span>
  <span class="kn">with</span> <span class="nv">p</span><span class="p">;</span> <span class="p">[$</span><span class="nv">NAPKIN_EXTRA_PACKAGES</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div></div> <p>Note, that packages, specified with <code class="language-plaintext highlighter-rouge">NAPKIN_EXTRA_PACKAGES</code> variable, are pulled from Nix, so every package should exist in Nix, for example: <a href="https://search.nixos.org/packages?channel=21.11&amp;from=0&amp;size=50&amp;buckets=%7B%22package_attr_set%22%3A%5B%22haskellPackages%22%5D%2C%22package_license_set%22%3A%5B%5D%2C%22package_maintainers_set%22%3A%5B%5D%2C%22package_platforms%22%3A%5B%5D%7D&amp;sort=relevance&amp;type=packages&amp;query=cassava">cassava</a>).</p> <h1 id="technical-details"> <a href="#technical-details" class="anchor-heading" aria-labelledby="technical-details"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Technical details </h1> <h2 id="assumptions-and-internals"> <a href="#assumptions-and-internals" class="anchor-heading" aria-labelledby="assumptions-and-internals"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Assumptions and internals </h2> <p>Docker wrapper script provides a way to run Napkin inside a container. Being executed inside a container, it needs access to the project files you are working on. Wrapper script makes an assumption, that it will be executed from the project root folder and mounts current folder from the host machine to the <code class="language-plaintext highlighter-rouge">/project</code> folder inside a container: <code class="language-plaintext highlighter-rouge">--volume $PWD:/project</code>.</p> <p>Since Napkin uses user’s <code class="language-plaintext highlighter-rouge">$HOME</code> folder to cache BigQuery credentials in SQLite database, wrapper script also needs to mount <code class="language-plaintext highlighter-rouge">.napkin</code> folder from the host to the container: <code class="language-plaintext highlighter-rouge">--volume $HOME/.napkin:/home/napkin/.napkin</code>.</p> <p>Occasionally, Napkin wants to open some links in the user’s browser (docs, BigQuery oAuth flow, etc.). Since there is no access to the host’s browser from the running container, wrapper scripts mounts a host-container <code class="language-plaintext highlighter-rouge">pipe</code> (temp folder based), sets up own tiny browser wrapper inside a container <code class="language-plaintext highlighter-rouge">--volume $open:/tmp/open --volume $inbox:/tmp/inbox</code>, listens to any invocations on the host, and opens host’s browser normally with help of standard <code class="language-plaintext highlighter-rouge">open</code> (on Mac) or <code class="language-plaintext highlighter-rouge">xdg-open</code> (on Linux) utilities. It is also possible to specify preferred browser with <code class="language-plaintext highlighter-rouge">BROWSER</code> environment variable.</p> <p>BigQuery oAuth flow requires program to have a valid HTTP callback (has to be on localhost in case of standalone desktop program). But since Napkin in being run inside a container, wrapper script publishes the port from a container to host machine <code class="language-plaintext highlighter-rouge">--publish $oauth_port:9901</code>, which possible to override with corresponding environment variable: <code class="language-plaintext highlighter-rouge">oauth_port="${NAPKIN_OAUTH_PORT:=9901}"</code>.</p> <h2 id="commit-policy"> <a href="#commit-policy" class="anchor-heading" aria-labelledby="commit-policy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Commit policy </h2> <p>Wrapper script, extracted out of docker container to the host filesystem, contains exact versions of Napkin, nixpkgs and GHC compiler.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">image</span><span class="o">=</span><span class="s2">"soostone/napkin-exe:0.5.7-9db950fa"</span>
<span class="nv">NAPKIN_NIX_REVISION</span><span class="o">=</span><span class="s2">"85ec7e87563663c66fefc17bd76bc8b9036bd99c"</span>
<span class="nv">NAPKIN_NIX_SHA256</span><span class="o">=</span><span class="s2">"0w11dfym7s3blj3ygrv4fqf7rz292agknm5dmrl8nvdw4qxgbm9r"</span>
<span class="nv">NAPKIN_GHC_VERSION_COMPACT</span><span class="o">=</span><span class="s2">"ghc8107"</span>
<span class="nv">NAPKIN_GHC_VERSION</span><span class="o">=</span><span class="s2">"ghc-8.10.7"</span>
</code></pre></div></div> <p>That is precisely why on first use you see such output from docker in your terminal (but on on subsequent invocations):</p> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh &lt;<span class="o">(</span>docker run <span class="nt">--rm</span> soostone/napkin-exe <span class="nb">cat</span> /bin/napkin-docker<span class="o">)</span> version
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nable to find image 'soostone/napkin-exe:0.5.7-9db950fa' locally
0.5.7-9db950fa: Pulling from soostone/napkin-exe
Digest: sha256:cccb09930b22216a7ab97f0eef0d4299d4a62a3e44928d23e88085eb25d98159
Status: Downloaded newer image for soostone/napkin-exe:0.5.7-9db950fa
Napkin version: 0.5.7
Git commit hash: 9db950fad2469ed88522976f700c3f7446eb5176
Built at: 2021-12-02 17:35:21.03233944 UTC
</code></pre></div></div> <p>Since wrapper script has docker image tag as <code class="language-plaintext highlighter-rouge">soostone/napkin-exe:0.5.7-9db950fa</code> and not just <code class="language-plaintext highlighter-rouge">soostone/napkin-exe:latest</code>, it does an extra <code class="language-plaintext highlighter-rouge">pull</code>, but quickly realize then images are the same.</p> <p>Is is recommended to commit the wrapper script to the project git repository, so that other team members will use it.</p> </div> </div> <div class="main-content-rspander"></div> <div class="search-overlay"></div> </div> <footer class="site-footer"> <div class="site-footer-lspandex"></div> <div class="site-footer-rows"> <div class="site-footer-r1"> <div class="logo white-napkin"></div> <div class="link-table"> <a href="#" class="">Documenation</a> <a href="#" class="">Community</a> <a href="#" class="">Features</a> </div> <div class="link-table"> <a href="#" class="">Use Cases</a> <a href="#" class="">About napkin</a> <a href="#" class="">Contact</a> </div> <div class="gradient-border"> <a href="#" class="link-button">Get napkin</a> </div> </div> <div class="media-bar"> <span class="media-pad"> <a href="#" class="logo fb-logo"></a> </span> <span class="media-pad"> <a href="#" class="logo linked-in-logo"></a> </span> <span class="media-pad"> <a href="#" class="logo twitter-logo"></a> </span> </div> <div class="site-footer-copy-right"> <div class="copyright"> Copyright 2021 &copy; &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; <a href="#">Privacy Policy</a> </div> <div class="made-with"> Made with <span class="gradient-text heart">&#x2764;</span> in NYC </div> </div> </div> <div class="site-footer-rspandex"></div> </footer> <script type="text/javascript" src="/assets/js/copy.js"></script> <script type="text/javascript" src="/assets/js/highlight-active-link.js"></script> </body> </html>
